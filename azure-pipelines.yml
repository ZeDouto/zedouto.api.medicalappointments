# Maven package Java project Web App to Linux on Azure
# Build your Java project and deploy it to Azure as a Linux web app
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/java

trigger:
  branches:
    include:
      - master
      - dev

variables:  
  # Agent VM image name
  vmImageName: 'ubuntu-latest'

stages:
- stage: Configuration
  displayName: Config stage
  jobs:
    - job:
      displayName: 'Replace tokens in AppConfig.json'
      steps:
        - task: replacetokens@3
          inputs:
            rootDirectory: '$(System.DefaultWorkingDirectory)/_ZeDouto.zedouto.api.medicalappointments/drop/src/main/resources'
            targetFiles: 'AppConfig.json'
            encoding: 'auto'
            writeBOM: true
            actionOnMissing: 'warn'
            keepToken: false
            tokenPrefix: '#{'
            tokenSuffix: '}#'
            useLegacyPattern: false
            enableTelemetry: true

- stage: Build
  displayName: Build stage
  jobs:
  - job: MavenPackageAndPublishArtifacts
    displayName: Maven Package and Publish Artifacts
    pool:
      vmImage: $(vmImageName)
    
    steps:
    - task: Maven@3
      displayName: 'Maven Package'
      inputs:
        mavenPomFile: 'pom.xml'

- stage: 
  displayName: 'Copy and Publish artifact/config files'
  jobs:
    - job:
      displayName: 'Publish artifact'
      steps:
        - task: PublishBuildArtifacts@1
          inputs:
            PathtoPublish: '$(System.DefaultWorkingDirectory)'
            ArtifactName: 'drop'
            publishLocation: 'Container'
        
        - script: | 
            ls $(System.DefaultWorkingDirectory)
            ls $(System.DefaultWorkingDirectory)/src
            ls $(System.DefaultWorkingDirectory)/src/main
            ls $(System.DefaultWorkingDirectory)/src/main/resources
          displayName: 'List directories'